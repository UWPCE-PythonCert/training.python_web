<!--
Google IO 2012/2013 HTML5 Slide Template

Authors: Eric Bidelman <ebidel@gmail.com>
         Luke Mah√© <lukem@google.com>

URL: https://code.google.com/p/io-2012-slides
--><!DOCTYPE html>


<html>
<head>
  <title>Session 04 &mdash; Internet Programming with Python</title>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <!--<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">-->
  <!--<meta name="viewport" content="width=device-width, initial-scale=1.0">-->
  <!--This one seems to work all the time, but really small on ipad-->
  <!--<meta name="viewport" content="initial-scale=0.4">-->
  <meta name="apple-mobile-web-app-capable" content="yes">

  
  <link rel="stylesheet" media="all"
        href="../_static/theme/css/default.css">
  <link rel="stylesheet" media="all"
        href="../_static/theme/css/hieroglyph.css">
  <link rel="stylesheet" media="only screen and (max-device-width: 480px)"
        href="../_static/theme/css/phone.css">

    
    <link rel="stylesheet" href="../_static/custom.css"
          type="text/css" />
    

    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <base target="_blank"> <!-- This amazingness opens all links in a new tab. -->
  
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '3.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>

    <script data-main="../_static/js/slides"
            src="../_static/js/require-1.0.8.min.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="top" title="Internet Programming with Python" href="../index.html" />
    <link rel="up" title="Course Presentations" href="index.html" />
    <link rel="next" title="Session 05" href="session05.html" />
    <link rel="prev" title="Session 03" href="session03.html" /> 
</head>
<body style="opacity: 0">

<slides class="layout-widescreen">

  <slide class="title-slide segue nobackground">
  <aside class="gdbar"><img src="../_static/logo_UW.png"></aside>
  <!-- The content of this hgroup is replaced programmatically through the slide_config.json. -->
  <hgroup class="auto-fadein">
    <h1 data-config-title><!-- populated from slide_config.json --></h1>
    <h2 data-config-subtitle><!-- populated from slide_config.json --></h2>
    <p data-config-presenter><!-- populated from slide_config.json --></p>
  </hgroup>
</slide>

  
    <slide class="title-slide segue nobackground level-1" id="session-04">
    <hgroup>
      <h1>Session 04</h1>
    </hgroup>
    <article class="">
      <div class="figure align-center" id="id3">
<a class="reference internal image-reference" href="../_images/granny_mashup.png"><img alt="../_images/granny_mashup.png" src="../_images/granny_mashup.png" style="width: 70%;" /></a>
<p class="caption"><span class="caption-text">Paul Downey <a class="reference external" href="http://www.flickr.com/photos/psd/492139935/">http://www.flickr.com/photos/psd/492139935/</a> - CC-BY</span></p>
</div>



<div class="slide-no">1</div>


    </article>
  </slide>  <slide class="level-2" id="scraping-apis-and-mashups">
    <hgroup>
      <h2>Scraping, APIs and Mashups</h2>
    </hgroup>
    <article class="">
      <p>Wherein we learn how to make order from the chaos of the wild internet.</p>



<div class="slide-no">2</div>


    </article>
  </slide>  <slide class="level-3" id="a-dilemma">
    <hgroup>
      <h3>A Dilemma</h3>
    </hgroup>
    <article class="">
      <p>The internet makes a vast quantity of data available.</p>
<div class="build docutils container">
<p>But not always in the form or combination you want.</p>
<p>It would be nice to be able to combine data from different sources to
create <em>meaning</em>.</p>
</div>



<div class="slide-no">3</div>


    </article>
  </slide>  <slide class="level-3" id="the-big-question">
    <hgroup>
      <h3>The Big Question</h3>
    </hgroup>
    <article class="">
      <p class="large centered">But How?</p>



<div class="slide-no">4</div>


    </article>
  </slide>  <slide class="level-3" id="the-big-answer">
    <hgroup>
      <h3>The Big Answer</h3>
    </hgroup>
    <article class="">
      <p class="large centered">Mashups</p>



<div class="slide-no">5</div>


    </article>
  </slide>  <slide class="level-3" id="mashups">
    <hgroup>
      <h3>Mashups</h3>
    </hgroup>
    <article class="">
      <p>A mashup is:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="n">web</span> <span class="n">page</span><span class="p">,</span> <span class="ow">or</span> <span class="n">web</span> <span class="n">application</span><span class="p">,</span> <span class="n">that</span> <span class="n">uses</span> <span class="ow">and</span> <span class="n">combines</span> <span class="n">data</span><span class="p">,</span> <span class="n">presentation</span>
<span class="ow">or</span> <span class="n">functionality</span> <span class="kn">from</span> <span class="nn">two</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">sources</span> <span class="n">to</span> <span class="n">create</span> <span class="n">new</span> <span class="n">services</span><span class="o">.</span>

<span class="o">--</span> <span class="n">wikipedia</span> <span class="p">(</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">en</span><span class="o">.</span><span class="n">wikipedia</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">wiki</span><span class="o">/</span><span class="n">Mashup_</span><span class="p">(</span><span class="n">web_application_hybrid</span><span class="p">))</span>
</pre></div>
</div>



<div class="slide-no">6</div>


    </article>
  </slide>  <slide class="level-3" id="data-sources">
    <hgroup>
      <h3>Data Sources</h3>
    </hgroup>
    <article class="">
      <p>The key to mashups is the idea of data sources.</p>
<div class="build docutils container">
<p>These come in many flavors:</p>
<ul class="build simple">
<li>Simple websites with data in HTML</li>
<li>Web services providing structured data</li>
<li>Web services providing tranformative service (geocoding)</li>
<li>Web services providing presentation (mapping)</li>
</ul>
</div>



<div class="slide-no">7</div>


    </article>
  </slide>  <slide class="level-2" id="web-scraping">
    <hgroup>
      <h2>Web Scraping</h2>
    </hgroup>
    <article class="">
      <div class="left docutils container">
<p>It would be nice if all online data were available in well-structured formats.</p>
<div class="build docutils container">
<p>The reality is that much data is available only in HTML.</p>
<p>Still we can get at it, with some effort.</p>
<p>By scraping the data from the web pages.</p>
</div>
</div>



<div class="slide-no">8</div>


    </article>
  </slide>  <slide class="level-3" id="html">
    <hgroup>
      <h3>HTML</h3>
    </hgroup>
    <article class="">
      <div class="highlight-html"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>A nice clean paragraph<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>And another nice clean paragraph<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>



<div class="slide-no">9</div>


    </article>
  </slide>  <slide class="level-3" id="id5">
    <hgroup>
      <h3>HTML... IRL</h3>
    </hgroup>
    <article class="">
      <div class="highlight-html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
 <span class="p">&lt;</span><span class="nt">form</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">table</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;input1&quot;</span><span class="p">&gt;</span>Row 1 cell 1
   <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;&lt;</span><span class="nt">td</span><span class="p">&gt;</span>Row 2 cell 1
  <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>Row 2 cell 2<span class="p">&lt;</span><span class="nt">br</span><span class="p">&gt;</span>This<span class="p">&lt;/</span><span class="nt">br</span><span class="p">&gt;</span> sure is a long cell
 <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>



<div class="slide-no">10</div>


    </article>
  </slide>  <slide class="level-3" id="id6">
    <hgroup>
      <h3>FFFFFFFFFUUUUUUUUUUUUU!!!!</h3>
    </hgroup>
    <article class="">
      <div class="figure align-center" id="id4">
<a class="reference internal image-reference" href="../_images/scream.jpg"><img alt="../_images/scream.jpg" src="../_images/scream.jpg" style="width: 32%;" /></a>
<p class="caption"><span class="caption-text">Photo by Matthew via Flickr (<a class="reference external" href="http://www.flickr.com/photos/purplemattfish/3918004964/">http://www.flickr.com/photos/purplemattfish/3918004964/</a>) - CC-BY-NC-ND</span></p>
</div>



<div class="slide-no">11</div>


    </article>
  </slide>  <slide class="level-3" id="id7">
    <hgroup>
      <h3>The Law of The Internet</h3>
    </hgroup>
    <article class="">
      <p class="large centered">&quot;Be strict in what you send and tolerant in what you receive&quot;</p>



<div class="slide-no">12</div>


    </article>
  </slide>  <slide class="level-3" id="taming-the-mess">
    <hgroup>
      <h3>Taming the Mess</h3>
    </hgroup>
    <article class="">
      <p>Luckily, there are tools to help with this.</p>
<div class="build docutils container">
<p>In python there are several candidates, but I like <code class="docutils literal"><span class="pre">BeautifulSoup</span></code>.</p>
<p>BeautifulSoup is a great tool, but it's not in the Standard Library.</p>
<p>We'll need to install it.</p>
<p>Create a virtualenv to do so:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ pyvenv soupenv
...
$ <span class="nb">source</span> soupenv/bin/activate
</pre></div>
</div>
<p>(remember, for Windows users that should be <code class="docutils literal"><span class="pre">soupenv/Scripts/activate.bat</span></code>)</p>
</div>



<div class="slide-no">13</div>


    </article>
  </slide>  <slide class="level-3" id="id8">
    <hgroup>
      <h3>Install BeautifulSoup</h3>
    </hgroup>
    <article class="">
      <p>Once the virtualenv is activated, you can simply use pip or easy_install to
install the libraries you want:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">(</span>soupenv<span class="o">)</span>$ pip install beautifulsoup4
</pre></div>
</div>



<div class="slide-no">14</div>


    </article>
  </slide>  <slide class="level-3" id="id9">
    <hgroup>
      <h3>Choose a Parsing Engine</h3>
    </hgroup>
    <article class="">
      <p>BeautifulSoup is built to use the Python HTMLParser.</p>
<ul class="build simple">
<li>Batteries Included.  It's already there</li>
<li>It's not great, especially before Python 2.7.3</li>
</ul>
<div class="build docutils container">
<p>BeautifulSoup also supports using other parsers.</p>
<p>There are two good choices: <code class="docutils literal"><span class="pre">lxml</span></code> and <code class="docutils literal"><span class="pre">html5lib</span></code>.</p>
<p><code class="docutils literal"><span class="pre">lxml</span></code> is better, but much harder to install.  Let's use <code class="docutils literal"><span class="pre">html5lib</span></code>.</p>
</div>



<div class="slide-no">15</div>


    </article>
  </slide>  <slide class="level-3" id="id10">
    <hgroup>
      <h3>Install a Parsing Engine</h3>
    </hgroup>
    <article class="">
      <p>Again, this is pretty simple:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>(soupenv)$ pip install html5lib
</pre></div>
</div>
<div class="build docutils container">
<p>Once installed, BeautifulSoup will choose it automatically.</p>
<p>BeautifulSoup will choose the &quot;best&quot; available.</p>
<p>You can specify the parser if you need to for some reason.</p>
<p>In fact, in recent versions of BeautifulSoup, you'll be warned if you don't
(though you can ignore the warning).</p>
</div>



<div class="slide-no">16</div>


    </article>
  </slide>  <slide class="level-3" id="id11">
    <hgroup>
      <h3>Install Requests</h3>
    </hgroup>
    <article class="">
      <p>Python provides tools for opening urls and communicating with servers. It's
spread across the <code class="docutils literal"><span class="pre">urllib</span></code> and <code class="docutils literal"><span class="pre">urllib2</span></code> packages.</p>
<div class="build docutils container">
<p>These packages have pretty unintuitive APIs.</p>
<p>The <code class="docutils literal"><span class="pre">requests</span></code> library is becoming the de-facto standard for this type of
work.  Let's install it too.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">(</span>soupenv<span class="o">)</span>$ pip install requests
</pre></div>
</div>
</div>



<div class="slide-no">17</div>


    </article>
  </slide>  <slide class="level-3" id="our-class-mashup">
    <hgroup>
      <h3>Our Class Mashup</h3>
    </hgroup>
    <article class="">
      <p>We're going to explore some tools for making a mashup today</p>
<div class="build docutils container">
<p>We'll be starting by scraping restaurant health code data for
a given ZIP code</p>
<p>Then, we'll look up the geographic location of those zipcodes using Google</p>
<p>Finally, we'll display the results of our work on a map</p>
<p>Start by opening a new file in your editor: <code class="docutils literal"><span class="pre">mashup.py</span></code>.</p>
</div>



<div class="slide-no">18</div>


    </article>
  </slide>  <slide class="level-3" id="id12">
    <hgroup>
      <h3>Getting Some HTML</h3>
    </hgroup>
    <article class="">
      <p>The source for the data we'll be displaying is a search tool provided by King
County.</p>
<div class="build docutils container">
<p>It's supposed to have a web service, but the service is broken.</p>
<p>Luckily, the HTML search works just fine.</p>
<p>Open <a class="reference external" href="http://info.kingcounty.gov/health/ehs/foodsafety/inspections/search.aspx">the search form</a> in your browser.</p>
<p>Fill in a ZIP code (perhaps 98101).</p>
<p>Add a start and end date (perhaps about 1 or 2 years apart).</p>
<p>Submit the form, and take a look at what you get.</p>
</div>



<div class="slide-no">19</div>


    </article>
  </slide>  <slide class="level-3" id="id13">
    <hgroup>
      <h3>Repeat, But Automate</h3>
    </hgroup>
    <article class="">
      <p>Next we want to automate the process.</p>
<div class="build docutils container">
<p>Copy the domain and path of the url into your new <code class="docutils literal"><span class="pre">mashup.py</span></code> file like
so:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">INSPECTION_DOMAIN</span> <span class="o">=</span> <span class="s2">&quot;http://info.kingcounty.gov&quot;</span>
<span class="n">INSPECTION_PATH</span> <span class="o">=</span> <span class="s2">&quot;/health/ehs/foodsafety/inspections/Results.aspx&quot;</span>
</pre></div>
</div>
</div>



<div class="slide-no">20</div>


    </article>
  </slide>  <slide class="level-3" id="id14">
    <hgroup>
      <h3>Repeat, But Automate</h3>
    </hgroup>
    <article class="">
      <p>Next, copy the query parameters from the URL and convert them to a dictionary:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">INSPECTION_PARAMS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Output&#39;</span><span class="p">:</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Business_Name&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Business_Address&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Longitude&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Latitude&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;City&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Zip_Code&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Inspection_Type&#39;</span><span class="p">:</span> <span class="s1">&#39;All&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Inspection_Start&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Inspection_End&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Inspection_Closed_Business&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Violation_Points&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Violation_Red_Points&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Violation_Descr&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Fuzzy_Search&#39;</span><span class="p">:</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Sort&#39;</span><span class="p">:</span> <span class="s1">&#39;H&#39;</span>
<span class="p">}</span>
</pre></div>
</div>



<div class="slide-no">21</div>


    </article>
  </slide>  <slide class="level-3" id="fetching-search-results">
    <hgroup>
      <h3>Fetching Search Results</h3>
    </hgroup>
    <article class="">
      <p>Next we'll use the <code class="docutils literal"><span class="pre">requests</span></code> library to write a function to fetch these
results on demand.</p>
<div class="build docutils container">
<p>In <code class="docutils literal"><span class="pre">requests</span></code>, each HTTP method has a module-level function:</p>
<ul class="build simple">
<li><code class="docutils literal"><span class="pre">GET</span></code> == <code class="docutils literal"><span class="pre">requests.get(url,</span> <span class="pre">**kwargs)</span></code></li>
<li><code class="docutils literal"><span class="pre">POST</span></code> == <code class="docutils literal"><span class="pre">requests.post(url,</span> <span class="pre">**kwargs)</span></code></li>
<li>...</li>
</ul>
<p><code class="docutils literal"><span class="pre">kwargs</span></code> represent other parts of an HTTP request:</p>
<ul class="build simple">
<li><code class="docutils literal"><span class="pre">params</span></code>: a dict of url parameters (?foo=bar&amp;baz=bim)</li>
<li><code class="docutils literal"><span class="pre">headers</span></code>: a dict of headers to send with the request</li>
<li><code class="docutils literal"><span class="pre">data</span></code>: the body of the request, if any (form data for POST goes here)</li>
<li>...</li>
</ul>
</div>



<div class="slide-no">22</div>


    </article>
  </slide>  <slide class="level-3" id="id15">
    <hgroup>
      <h3>Handling Requests Responses</h3>
    </hgroup>
    <article class="">
      <p>The return value from one of these functions is a <code class="docutils literal"><span class="pre">response</span></code> object which
provides:</p>
<div class="build docutils container">
<ul class="build simple">
<li><code class="docutils literal"><span class="pre">response.status_code</span></code>: see the HTTP Status Code returned</li>
<li><code class="docutils literal"><span class="pre">response.ok</span></code>: True if <code class="docutils literal"><span class="pre">response.status_code</span></code> is not an error</li>
<li><code class="docutils literal"><span class="pre">response.raise_for_status()</span></code>: call to raise a python error if it is</li>
<li><code class="docutils literal"><span class="pre">response.headers</span></code>: The headers sent from the server</li>
<li><code class="docutils literal"><span class="pre">response.text</span></code>: Body of the response, decoded to unicode</li>
<li><code class="docutils literal"><span class="pre">response.encoding</span></code>: The encoding used to decode</li>
<li><code class="docutils literal"><span class="pre">response.content</span></code>: The original encoded response body as bytes</li>
</ul>
<p><code class="docutils literal"><span class="pre">requests</span> <span class="pre">documentation</span></code>: <a class="reference external" href="http://docs.python-requests.org/en/latest/">http://docs.python-requests.org/en/latest/</a></p>
</div>



<div class="slide-no">23</div>


    </article>
  </slide>  <slide class="level-3" id="id16">
    <hgroup>
      <h3>Fetch Search Results</h3>
    </hgroup>
    <article class="">
      <p>We'll start by writing a function <code class="docutils literal"><span class="pre">get_inspection_page</span></code></p>
<div class="build docutils container">
<ul class="build simple">
<li>It will accept keyword arguments for each of the possible query values</li>
<li>It will build a dictionary of request query parameters from incoming
keywords, using INSPECTION_PARAMS as a template</li>
<li>It will make a request to the inspection service search page using this
query</li>
<li>It will return the encoded content and the encoding used as a tuple</li>
</ul>
<p>Try writing this function. Put it in <code class="docutils literal"><span class="pre">mashup.py</span></code></p>
</div>



<div class="slide-no">24</div>


    </article>
  </slide>  <slide class="level-3" id="my-solution">
    <hgroup>
      <h3>My Solution</h3>
    </hgroup>
    <article class="">
      <p>Here's the one I created:</p>
<div class="build highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>

<span class="k">def</span> <span class="nf">get_inspection_page</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">INSPECTION_DOMAIN</span> <span class="o">+</span> <span class="n">INSPECTION_PATH</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">INSPECTION_PARAMS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">INSPECTION_PARAMS</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span>
</pre></div>
</div>



<div class="slide-no">25</div>


    </article>
  </slide>  <slide class="level-3" id="parse-the-results">
    <hgroup>
      <h3>Parse the Results</h3>
    </hgroup>
    <article class="">
      <p>Next, we'll need to parse the results we get when we call that function</p>
<p>But before we start, a word about parsing HTML with BeautifulSoup</p>



<div class="slide-no">26</div>


    </article>
  </slide>  <slide class="level-3" id="id17">
    <hgroup>
      <h3>Parsing HTML with BeautifulSoup</h3>
    </hgroup>
    <article class="">
      <p>The BeautifulSoup object can be instantiated with a string or a file-like
object as the sole argument:</p>
<div class="build docutils container">
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="n">parsed</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="s1">&#39;&lt;h1&gt;Some HTML&lt;/h1&gt;&#39;</span><span class="p">)</span>

<span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;a_page.html&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">parsed</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>

<span class="n">page</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s1">&#39;http://site.com/page.html&#39;</span><span class="p">)</span>
<span class="n">parsed</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
</pre></div>
</div>
<p>You might want to open the documentation as reference
(<a class="reference external" href="http://www.crummy.com/software/BeautifulSoup/bs4/doc">http://www.crummy.com/software/BeautifulSoup/bs4/doc</a>)</p>
</div>



<div class="slide-no">27</div>


    </article>
  </slide>  <slide class="level-3" id="id1">
    <hgroup>
      <h3>My Solution</h3>
    </hgroup>
    <article class="">
      <p>Take a shot at writing this new function in <code class="docutils literal"><span class="pre">mashup.py</span></code></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># add this import at the top</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>

<span class="c1"># then add this function lower down</span>
<span class="k">def</span> <span class="nf">parse_source</span><span class="p">(</span><span class="n">html</span><span class="p">):</span>
    <span class="n">parsed</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parsed</span>
</pre></div>
</div>



<div class="slide-no">28</div>


    </article>
  </slide>  <slide class="level-3" id="put-it-together">
    <hgroup>
      <h3>Put It Together</h3>
    </hgroup>
    <article class="">
      <p>We'll need to make our script do something when run.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># do something</span>
</pre></div>
</div>
<div class="build docutils container">
<ul class="build simple">
<li>Fetch a search results page</li>
<li>Parse the resulting HTML</li>
<li>For now, print out the results so we can see what we get</li>
</ul>
<div class="docutils container">
<p>Use the <code class="docutils literal"><span class="pre">prettify</span></code> method on a BeautifulSoup object:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">prettify</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>



<div class="slide-no">29</div>


    </article>
  </slide>  <slide class="level-3" id="id2">
    <hgroup>
      <h3>My Solution</h3>
    </hgroup>
    <article class="">
      <p>Try to come up with the proper code on your own.  Add it to <code class="docutils literal"><span class="pre">mashup.py</span></code></p>
<div class="build highlight-python"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">use_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Inspection_Start&#39;</span><span class="p">:</span> <span class="s1">&#39;2/1/2013&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Inspection_End&#39;</span><span class="p">:</span> <span class="s1">&#39;2/1/2015&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Zip_Code&#39;</span><span class="p">:</span> <span class="s1">&#39;98101&#39;</span>
    <span class="p">}</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">get_inspection_page</span><span class="p">(</span><span class="o">**</span><span class="n">use_params</span><span class="p">)</span>
    <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse_source</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">prettify</span><span class="p">())</span>
</pre></div>
</div>



<div class="slide-no">30</div>


    </article>
  </slide>  <slide class="level-3" id="id18">
    <hgroup>
      <h3>Test The Results</h3>
    </hgroup>
    <article class="">
      <p>Assuming your virtualenv is still active, you should be able to execute the
script.</p>
<div class="build docutils container">
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">(</span>soupenv<span class="o">)</span>$ python mashup.py
...
   &lt;script <span class="nv">src</span><span class="o">=</span><span class="s2">&quot;http://www.kingcounty.gov/kcscripts/kcPageAnalytics.js&quot;</span> <span class="nv">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span>&gt;
   &lt;/script&gt;
   &lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span>&gt;
     //&lt;!<span class="o">[</span>CDATA<span class="o">[</span>
     var <span class="nv">usasearch_config</span> <span class="o">=</span> <span class="o">{</span> siteHandle:<span class="s2">&quot;kingcounty&quot;</span> <span class="o">}</span><span class="p">;</span>
     var <span class="nv">script</span> <span class="o">=</span> document.createElement<span class="o">(</span><span class="s2">&quot;script&quot;</span><span class="o">)</span><span class="p">;</span>
     script.type <span class="o">=</span> <span class="s2">&quot;text/javascript&quot;</span><span class="p">;</span>
     script.src <span class="o">=</span> <span class="s2">&quot;http://search.usa.gov/javascripts/remote.loader.js&quot;</span><span class="p">;</span>
     document.getElementsByTagName<span class="o">(</span><span class="s2">&quot;head&quot;</span><span class="o">)[</span>0<span class="o">]</span>.appendChild<span class="o">(</span>script<span class="o">)</span><span class="p">;</span>
     //<span class="o">]]</span>&gt;
   &lt;/script&gt;
  &lt;/form&gt;
 &lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
<p>This script is available as <code class="docutils literal"><span class="pre">resources/session04/mashup_1.py</span></code></p>
</div>



<div class="slide-no">31</div>


    </article>
  </slide>  <slide class="level-3" id="id19">
    <hgroup>
      <h3>Preserve the Results</h3>
    </hgroup>
    <article class="">
      <p>Now, let's re-run the script, saving the output to a file so we can use it
later:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ python mashup.py &gt; inspection_page.html
</pre></div>
</div>
<div class="build docutils container">
<p>Then add a quick function to our script that will use these saved results:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load_inspection_page</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">file_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, bolt that in to your script to use it:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># COMMENT OUT THIS LINE AND REPLACE IT</span>
<span class="c1"># html = get_inspection_page(**use_params)</span>
<span class="n">html</span> <span class="o">=</span> <span class="n">load_inspection_page</span><span class="p">(</span><span class="s1">&#39;inspection_page.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>



<div class="slide-no">32</div>


    </article>
  </slide>  <slide class="level-3" id="extracting-data">
    <hgroup>
      <h3>Extracting Data</h3>
    </hgroup>
    <article class="">
      <p>Next we find the bits of this pile of HTML that matter to us.</p>
<div class="build docutils container">
<p>Open the page you just wrote to disk in your web browser and open the
developer tools to inspect the page source.</p>
<p>You'll want to start by finding the element in the page that contains all
our search results.</p>
<p>Look at the source and identify the single element we are looking for.</p>
</div>



<div class="slide-no">33</div>


    </article>
  </slide>  <slide class="level-3" id="id20">
    <hgroup>
      <h3>Tags and Searching</h3>
    </hgroup>
    <article class="">
      <p>Having found it visually, we can now search for it automatically. In
BeautifulSoup:</p>
<div class="build docutils container">
<ul class="build simple">
<li>All HTML elements (including the parsed document itself) are <code class="docutils literal"><span class="pre">tags</span></code></li>
<li>A <code class="docutils literal"><span class="pre">tag</span></code> can be searched using its <code class="docutils literal"><span class="pre">find</span></code> or <code class="docutils literal"><span class="pre">find_all</span></code> methods</li>
<li>This searches the descendents of the tag on which it is called.</li>
<li>It takes arguments which act as <em>filters</em> on the search results</li>
</ul>
<div class="docutils container">
<p>like so:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">tag</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">recursive</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="n">tag</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">recursive</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>



<div class="slide-no">34</div>


    </article>
  </slide>  <slide class="level-3" id="id21">
    <hgroup>
      <h3>Searching by Attribute</h3>
    </hgroup>
    <article class="">
      <p>The <code class="docutils literal"><span class="pre">find</span></code> method allows us to pass <em>kwargs</em>.</p>
<div class="build docutils container">
<p>Keywords that are not among the named parameters will be considered an HTML
attribute.</p>
<p>We can use this to find the column that holds our search results:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">content_col</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;contentcol&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Add that line to our mashup script and try it out:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1">#...</span>
<span class="n">parsed</span> <span class="o">=</span> <span class="n">parse_source</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
<span class="n">content_col</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;td&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;contentcol&quot;</span><span class="p">)</span>
<span class="k">print</span> <span class="n">content_col</span><span class="o">.</span><span class="n">prettify</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">(</span>soupenv<span class="o">)</span>$ python mashup.py
&lt;td <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;contentcol&quot;</span>&gt;
    ...
&lt;/td&gt;
</pre></div>
</div>
</div>



<div class="slide-no">35</div>


    </article>
  </slide>  <slide class="level-3" id="id22">
    <hgroup>
      <h3>Filtering By Regular Expression</h3>
    </hgroup>
    <article class="">
      <p>The next job is to find the inspection data we can see when we click on the
restaurant names in our page.</p>
<div class="build docutils container">
<p>Do you notice a pattern in how that data is structured?</p>
<p>For each restaurant in our results, there are <em>two</em> <code class="docutils literal"><span class="pre">&lt;div&gt;</span></code> tags.</p>
<p>The first contains the content you see at first, the second the content
that displays when we click.</p>
<p>What can you see that identifies these items?</p>
<p><code class="docutils literal"><span class="pre">&lt;div</span> <span class="pre">id=&quot;PR0084952&quot;...&gt;</span></code> and <code class="docutils literal"><span class="pre">&lt;div</span> <span class="pre">id=&quot;PR0084952~&quot;...&gt;</span></code></p>
<p>Each pair shares an ID, and the stuff we want is in the second one</p>
<p>Each number is different for each restaurant</p>
<p>We can use a regular expression to help us here.</p>
</div>



<div class="slide-no">36</div>


    </article>
  </slide>  <slide class="level-3" id="id23">
    <hgroup>
      <h3>Getting the Information Divs</h3>
    </hgroup>
    <article class="">
      <p>Let's write a function in <code class="docutils literal"><span class="pre">mashup.py</span></code> that will find all the divs in our
column with the right kind of id:</p>
<div class="build docutils container">
<ul class="build simple">
<li>It should match <code class="docutils literal"><span class="pre">&lt;div&gt;</span></code> tags only</li>
<li>It should match ids that start with <code class="docutils literal"><span class="pre">PR</span></code></li>
<li>It should match ids that contain some number of <em>digits</em> after that</li>
<li>It should match ids that end with a <em>tilde</em> (<code class="docutils literal"><span class="pre">~</span></code>) character</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># add an import up top</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="c1"># and add this function</span>
<span class="k">def</span> <span class="nf">restaurant_data_generator</span><span class="p">(</span><span class="n">html</span><span class="p">):</span>
    <span class="n">id_finder</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;PR[\d]+~&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">html</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">id_finder</span><span class="p">)</span>
</pre></div>
</div>
</div>



<div class="slide-no">37</div>


    </article>
  </slide>  <slide class="level-3" id="id24">
    <hgroup>
      <h3>Verify It Works</h3>
    </hgroup>
    <article class="">
      <p>Let's add that step to the <em>main</em> block at the bottom of <code class="docutils literal"><span class="pre">mashup.py</span></code> (only
print the first of the many divs that match):</p>
<div class="build docutils container">
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">html</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="n">load_inspection_page</span><span class="p">(</span><span class="s1">&#39;inspection_page.html&#39;</span><span class="p">)</span>
<span class="n">parsed</span> <span class="o">=</span> <span class="n">parse_source</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span>
<span class="n">content_col</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;td&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;contentcol&quot;</span><span class="p">)</span>
<span class="n">data_list</span> <span class="o">=</span> <span class="n">restaurant_data_generator</span><span class="p">(</span><span class="n">content_col</span><span class="p">)</span>
<span class="k">print</span> <span class="n">data_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">prettify</span><span class="p">()</span>
</pre></div>
</div>
<p>Finally, test it out:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">(</span>soupenv<span class="o">)</span>$ python mashup.py
&lt;div <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;PR0001203~&quot;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;PR0001203~&quot;</span> <span class="nv">onclick</span><span class="o">=</span><span class="s2">&quot;toggleShow(this.id);&quot;</span>...&gt;
 &lt;table <span class="nv">style</span><span class="o">=</span><span class="s2">&quot;width: 635px;&quot;</span>&gt;
 ...
 &lt;/table&gt;
&lt;/div&gt;
</pre></div>
</div>
<p>This code is available as <code class="docutils literal"><span class="pre">/resources/session04/mashup_2.py</span></code></p>
</div>



<div class="slide-no">38</div>


    </article>
  </slide>  <slide class="level-3" id="parsing-restaurant-data">
    <hgroup>
      <h3>Parsing Restaurant Data</h3>
    </hgroup>
    <article class="">
      <p>Now that we have the records we want, we need to parse them.</p>
<div class="build docutils container">
<p>We'll start by extracting information about the restaurants:</p>
<ul class="build simple">
<li>Name</li>
<li>Address</li>
<li>Location</li>
</ul>
<p>How is this information contained in our records?</p>
</div>



<div class="slide-no">39</div>


    </article>
  </slide>  <slide class="level-3" id="id25">
    <hgroup>
      <h3>Complex Filtering</h3>
    </hgroup>
    <article class="">
      <p>Each record consists of a table with a series of <em>rows</em> (<code class="docutils literal"><span class="pre">&lt;tr&gt;</span></code>).</p>
<div class="build docutils container">
<p>The rows we want at this time all have two <em>cells</em> inside them.</p>
<p>The first contains the <em>label</em> of the data, the second contains the <em>value</em></p>
<p>We'll need a function in <code class="docutils literal"><span class="pre">mashup.py</span></code> that:</p>
<ul class="build simple">
<li>takes an HTML element as an argument</li>
<li>verifies that it is a <code class="docutils literal"><span class="pre">&lt;tr&gt;</span></code> element</li>
<li>verifies that it has two immediate children that are <code class="docutils literal"><span class="pre">&lt;td&gt;</span></code> elements</li>
</ul>
<p>My solution:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">has_two_tds</span><span class="p">(</span><span class="n">elem</span><span class="p">):</span>
    <span class="n">is_tr</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;tr&#39;</span>
    <span class="n">td_children</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">has_two</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">td_children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">is_tr</span> <span class="ow">and</span> <span class="n">has_two</span>
</pre></div>
</div>
</div>



<div class="slide-no">40</div>


    </article>
  </slide>  <slide class="level-3" id="id26">
    <hgroup>
      <h3>Test It Out</h3>
    </hgroup>
    <article class="">
      <p>Let's try this out in an interpreter:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [1]: </span><span class="kn">from</span> <span class="nn">mashup_3</span> <span class="kn">import</span> <span class="n">load_inspection_page</span><span class="p">,</span> <span class="n">parse_source</span><span class="p">,</span>
<span class="go">        restaurant_data_generator, has_two_tds</span>
<span class="gp">In [2]: </span><span class="n">html</span> <span class="o">=</span> <span class="n">load_inspection_page</span><span class="p">(</span><span class="s1">&#39;inspection_page.html&#39;</span><span class="p">)</span>
<span class="gp">In [3]: </span><span class="n">parsed</span> <span class="o">=</span> <span class="n">parse_source</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
<span class="go">...</span>
<span class="gp">In [4]: </span><span class="n">content_col</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;contentcol&#39;</span><span class="p">)</span>
<span class="gp">In [5]: </span><span class="n">records</span> <span class="o">=</span> <span class="n">restaurant_data_generator</span><span class="p">(</span><span class="n">content_col</span><span class="p">)</span>
<span class="gp">In [6]: </span><span class="n">rec</span> <span class="o">=</span> <span class="n">records</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
</pre></div>
</div>



<div class="slide-no">41</div>


    </article>
  </slide>  <slide class="level-3" id="id27">
    <hgroup>
      <h3>Test It Out</h3>
    </hgroup>
    <article class="">
      <p>We'd like to find all table rows in that div that contain <em>two</em> cells</p>
<div class="build docutils container">
<p>The table rows are all contained in a <code class="docutils literal"><span class="pre">&lt;tbody&gt;</span></code> tag.</p>
<p>We only want the ones at the top of that tag (ones nested more deeply
contain other data)</p>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [13]: </span><span class="n">data_rows</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;tbody&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">has_two_tds</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="gp">In [14]: </span><span class="nb">len</span><span class="p">(</span><span class="n">data_rows</span><span class="p">)</span>
<span class="gh">Out[14]: </span><span class="go">7</span>
<span class="gp">In [15]: </span><span class="k">print</span><span class="p">(</span><span class="n">data_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">prettify</span><span class="p">())</span>
<span class="go">&lt;tr&gt;</span>
<span class="go"> &lt;td class=&quot;promptTextBox&quot; style=&quot;width: 125px; font-weight: bold&quot;&gt;</span>
<span class="go">  - Business Name</span>
<span class="go"> &lt;/td&gt;</span>
<span class="go"> &lt;td class=&quot;promptTextBox&quot; style=&quot;width: 520px; font-weight: bold&quot;&gt;</span>
<span class="go">  SPICE ORIENT</span>
<span class="go"> &lt;/td&gt;</span>
<span class="go">&lt;/tr&gt;</span>
</pre></div>
</div>
</div>



<div class="slide-no">42</div>


    </article>
  </slide>  <slide class="level-3" id="id28">
    <hgroup>
      <h3>Extracting Labels and Values</h3>
    </hgroup>
    <article class="">
      <p>Now we have a list of the rows that contain our data.</p>
<div class="build docutils container">
<p>Next we have to collect the data they contain</p>
<p>The <em>label/value</em> structure of this data should suggest the right container
to store the information.</p>
<p>Let's start by trying to get at the first label</p>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [18]: </span><span class="n">row1</span> <span class="o">=</span> <span class="n">data_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">In [19]: </span><span class="n">cells</span> <span class="o">=</span> <span class="n">row1</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">)</span>
<span class="gp">In [20]: </span><span class="n">cell1</span> <span class="o">=</span> <span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">In [21]: </span><span class="n">cell1</span><span class="o">.</span><span class="n">text</span>
<span class="gh">Out[21]: </span><span class="go">&#39;\n            - Business Name\n           &#39;</span>
</pre></div>
</div>
<p>That works well enough, but all that extra stuff is nasty</p>
<p>We need a method to clean up the text we get from these cells</p>
<p>It should strip extra whitespace, and characters like <code class="docutils literal"><span class="pre">-</span></code> and <code class="docutils literal"><span class="pre">:</span></code> we
don't want.</p>
</div>



<div class="slide-no">43</div>


    </article>
  </slide>  <slide class="level-3" id="id29">
    <hgroup>
      <h3>My Solution</h3>
    </hgroup>
    <article class="">
      <p>Try writing such a function for yourself now in <code class="docutils literal"><span class="pre">mashup.py</span></code></p>
<div class="build docutils container">
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">clean_data</span><span class="p">(</span><span class="n">td</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">td</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot; </span><span class="se">\n</span><span class="s2">:-&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Add it to your interpreter and test it out:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [25]: </span><span class="k">def</span> <span class="nf">clean_data</span><span class="p">(</span><span class="n">td</span><span class="p">):</span>
<span class="gp">   ....: </span>    <span class="k">return</span> <span class="n">td</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot; </span><span class="se">\n</span><span class="s2">:-&quot;</span><span class="p">)</span>
<span class="gp">   ....:</span>
<span class="gp">In [26]: </span><span class="n">clean_data</span><span class="p">(</span><span class="n">cell1</span><span class="p">)</span>
<span class="gh">Out[26]: </span><span class="go">&#39;Business Name&#39;</span>
<span class="gp">In [27]:</span>
</pre></div>
</div>
<p>Ahhh, much better</p>
</div>



<div class="slide-no">44</div>


    </article>
  </slide>  <slide class="level-3" id="id30">
    <hgroup>
      <h3>The Complete Function</h3>
    </hgroup>
    <article class="">
      <p>So we can get a list of the rows that contain label/value pairs.</p>
<div class="build docutils container">
<p>And we can extract clean values from the cells in these rows</p>
<p>Now we need a function in <code class="docutils literal"><span class="pre">mashup.py</span></code> that will iterate through the rows
we find and build a dictionary of the pairs.</p>
<p>We have to be cautious because some rows don't have a label.</p>
<p>The values in these rows should go with the label from the previous row.</p>
</div>



<div class="slide-no">45</div>


    </article>
  </slide>  <slide class="level-3" id="id31">
    <hgroup>
      <h3>My Solution</h3>
    </hgroup>
    <article class="">
      <p>Here's the version I came up with:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">extract_restaurant_metadata</span><span class="p">(</span><span class="n">elem</span><span class="p">):</span>
    <span class="n">restaurant_data_rows</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;tbody&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span>
        <span class="n">has_two_tds</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="bp">False</span>
    <span class="p">)</span>
    <span class="n">rdata</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">current_label</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">data_row</span> <span class="ow">in</span> <span class="n">restaurant_data_rows</span><span class="p">:</span>
        <span class="n">key_cell</span><span class="p">,</span> <span class="n">val_cell</span> <span class="o">=</span> <span class="n">data_row</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">new_label</span> <span class="o">=</span> <span class="n">clean_data</span><span class="p">(</span><span class="n">key_cell</span><span class="p">)</span>
        <span class="n">current_label</span> <span class="o">=</span> <span class="n">new_label</span> <span class="k">if</span> <span class="n">new_label</span> <span class="k">else</span> <span class="n">current_label</span>
        <span class="n">rdata</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">current_label</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clean_data</span><span class="p">(</span><span class="n">val_cell</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">rdata</span>
</pre></div>
</div>



<div class="slide-no">46</div>


    </article>
  </slide>  <slide class="level-3" id="id32">
    <hgroup>
      <h3>Testing It Out</h3>
    </hgroup>
    <article class="">
      <p>Add it to our script:</p>
<div class="build docutils container">
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># ...</span>
<span class="n">data_list</span> <span class="o">=</span> <span class="n">restaurant_data_generator</span><span class="p">(</span><span class="n">content_col</span><span class="p">)</span>
<span class="k">for</span> <span class="n">data_div</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">extract_restaurant_metadata</span><span class="p">(</span><span class="n">data_div</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">metadata</span>
</pre></div>
</div>
<p>And then try it out:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">(</span>soupenv<span class="o">)</span>$ python mashup.py
...
<span class="o">{</span>u<span class="s1">&#39;Business Category&#39;</span>: <span class="o">[</span>u<span class="s1">&#39;Seating 0-12 - Risk Category III&#39;</span><span class="o">]</span>,
 u<span class="s1">&#39;Longitude&#39;</span>: <span class="o">[</span>u<span class="s1">&#39;122.3401786000&#39;</span><span class="o">]</span>, u<span class="s1">&#39;Phone&#39;</span>: <span class="o">[</span>u<span class="s1">&#39;(206) 501-9554&#39;</span><span class="o">]</span>,
 u<span class="s1">&#39;Business Name&#39;</span>: <span class="o">[</span>u<span class="s2">&quot;ZACCAGNI&#39;S&quot;</span><span class="o">]</span>, u<span class="s1">&#39;Address&#39;</span>: <span class="o">[</span>u<span class="s1">&#39;97B PIKE ST&#39;</span>, u<span class="s1">&#39;SEATTLE, WA 98101&#39;</span><span class="o">]</span>,
 u<span class="s1">&#39;Latitude&#39;</span>: <span class="o">[</span>u<span class="s1">&#39;47.6086651300&#39;</span><span class="o">]}</span>
</pre></div>
</div>
<p>This script is available as <code class="docutils literal"><span class="pre">resources/session04/mashup_3.py</span></code></p>
</div>



<div class="slide-no">47</div>


    </article>
  </slide>  <slide class="level-3" id="extracting-inspection-data">
    <hgroup>
      <h3>Extracting Inspection Data</h3>
    </hgroup>
    <article class="">
      <p>The final step is to extract the inspection data for each restaurant.</p>
<div class="build docutils container">
<p>We want to capture only the score from each inspection, details we can
leave behind.</p>
<p>We'd like to calculate the average score for all known inspections.</p>
<p>We'd also like to know how many inspections there were in total.</p>
<p>Finally, we'd like to preserve the highest score of all inspections for a
restaurant.</p>
<p>We'll add this information to our metadata about the restaurant.</p>
</div>



<div class="slide-no">48</div>


    </article>
  </slide>  <slide class="level-3" id="id33">
    <hgroup>
      <h3>Finding the Data</h3>
    </hgroup>
    <article class="">
      <p>Let's start by getting our bearings. Return to viewing the
<code class="docutils literal"><span class="pre">inspection_page.html</span></code> you saved in a browser.</p>
<div class="build docutils container">
<p>Find a restaurant that has had an inspection or two.</p>
<p>What can you say about the HTML that contains the scores for these
inspections?</p>
<p>I notice four characteristics that let us isolate the information we want:</p>
<ul class="build simple">
<li>Inspection data is containd in <code class="docutils literal"><span class="pre">&lt;tr&gt;</span></code> elements</li>
<li>Rows with inspection data in them have four <code class="docutils literal"><span class="pre">&lt;td&gt;</span></code> children</li>
<li>The text in the first cell contains the word &quot;inspection&quot;</li>
<li>But the text does not <em>start</em> with the word &quot;inspection&quot;</li>
</ul>
<p>Let's try to write a filter function like the one above that will catch
these rows for us.</p>
</div>



<div class="slide-no">49</div>


    </article>
  </slide>  <slide class="level-3" id="id34">
    <hgroup>
      <h3>The filter</h3>
    </hgroup>
    <article class="">
      <p>Add this new function <code class="docutils literal"><span class="pre">is_inspection_data_row</span></code> to <code class="docutils literal"><span class="pre">mashup.py</span></code></p>
<div class="build highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">is_inspection_data_row</span><span class="p">(</span><span class="n">elem</span><span class="p">):</span>
    <span class="n">is_tr</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;tr&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_tr</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="n">td_children</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">has_four</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">td_children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>
    <span class="n">this_text</span> <span class="o">=</span> <span class="n">clean_data</span><span class="p">(</span><span class="n">td_children</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">contains_word</span> <span class="o">=</span> <span class="s1">&#39;inspection&#39;</span> <span class="ow">in</span> <span class="n">this_text</span>
    <span class="n">does_not_start</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">this_text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;inspection&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">is_tr</span> <span class="ow">and</span> <span class="n">has_four</span> <span class="ow">and</span> <span class="n">contains_word</span> <span class="ow">and</span> <span class="n">does_not_start</span>
</pre></div>
</div>



<div class="slide-no">50</div>


    </article>
  </slide>  <slide class="level-3" id="id35">
    <hgroup>
      <h3>Test It Out</h3>
    </hgroup>
    <article class="">
      <p>We can test this function by adding it into our script:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">data_div</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">extract_restaurant_metadata</span><span class="p">(</span><span class="n">data_div</span><span class="p">)</span>
    <span class="c1"># UPDATE THIS BELOW HERE</span>
    <span class="n">inspection_rows</span> <span class="o">=</span> <span class="n">data_div</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">is_inspection_data_row</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inspection_rows</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<div class="build docutils container">
<p>And try running the script in your terminal:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">(</span>soupenv<span class="o">)</span>$ python mashup.py
<span class="o">{</span>u<span class="s1">&#39;Business Category&#39;</span>: <span class="o">[</span>u<span class="s1">&#39;Seating 0-12 - Risk Category III&#39;</span><span class="o">]</span>,
 u<span class="s1">&#39;Longitude&#39;</span>: <span class="o">[</span>u<span class="s1">&#39;122.3401786000&#39;</span><span class="o">]</span>, u<span class="s1">&#39;Phone&#39;</span>: <span class="o">[</span>u<span class="s1">&#39;(206) 501-9554&#39;</span><span class="o">]</span>,
 u<span class="s1">&#39;Business Name&#39;</span>: <span class="o">[</span>u<span class="s2">&quot;ZACCAGNI&#39;S&quot;</span><span class="o">]</span>, u<span class="s1">&#39;Address&#39;</span>: <span class="o">[</span>u<span class="s1">&#39;97B PIKE ST&#39;</span>, u<span class="s1">&#39;SEATTLE, WA 98101&#39;</span><span class="o">]</span>,
 u<span class="s1">&#39;Latitude&#39;</span>: <span class="o">[</span>u<span class="s1">&#39;47.6086651300&#39;</span><span class="o">]}</span>
0
**********
</pre></div>
</div>
</div>



<div class="slide-no">51</div>


    </article>
  </slide>  <slide class="level-3" id="id36">
    <hgroup>
      <h3>Building Inspection Data</h3>
    </hgroup>
    <article class="">
      <p>Now we can isolate a list of the rows that contain inspection data.</p>
<div class="build docutils container">
<p>Next we need to calculate the average score, total number and highest score
for each restaurant.</p>
<p>Let's add a function to <code class="docutils literal"><span class="pre">mashup.py</span></code> that will:</p>
<ul class="build simple">
<li>Take a div containing a restaurant record</li>
<li>Extract the rows containing inspection data</li>
<li>Keep track of the highest score recorded</li>
<li>Sum the total of all inspections</li>
<li>Count the number of inspections made</li>
<li>Calculate the average score for inspections</li>
<li>Return the three calculated values in a dictionary</li>
</ul>
</div>



<div class="slide-no">52</div>


    </article>
  </slide>  <slide class="level-3" id="id37">
    <hgroup>
      <h3>My Solution</h3>
    </hgroup>
    <article class="">
      <p>Try writing this routine yourself.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_score_data</span><span class="p">(</span><span class="n">elem</span><span class="p">):</span>
    <span class="n">inspection_rows</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">is_inspection_data_row</span><span class="p">)</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inspection_rows</span><span class="p">)</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">high_score</span> <span class="o">=</span> <span class="n">average</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">inspection_rows</span><span class="p">:</span>
        <span class="n">strval</span> <span class="o">=</span> <span class="n">clean_data</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">intval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">strval</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">samples</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">intval</span>
            <span class="n">high_score</span> <span class="o">=</span> <span class="n">intval</span> <span class="k">if</span> <span class="n">intval</span> <span class="o">&gt;</span> <span class="n">high_score</span> <span class="k">else</span> <span class="n">high_score</span>
    <span class="k">if</span> <span class="n">samples</span><span class="p">:</span>
        <span class="n">average</span> <span class="o">=</span> <span class="n">total</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;Average Score&#39;</span><span class="p">:</span> <span class="n">average</span><span class="p">,</span> <span class="s1">&#39;High Score&#39;</span><span class="p">:</span> <span class="n">high_score</span><span class="p">,</span>
            <span class="s1">&#39;Total Inspections&#39;</span><span class="p">:</span> <span class="n">samples</span><span class="p">}</span>
</pre></div>
</div>



<div class="slide-no">53</div>


    </article>
  </slide>  <slide class="level-3" id="id38">
    <hgroup>
      <h3>Test It Out</h3>
    </hgroup>
    <article class="">
      <p>We can now incorporate this new routine into our <code class="docutils literal"><span class="pre">mashup</span></code> script.</p>
<div class="build docutils container">
<p>We'll want to add the data it produces to the metadata we've already
extracted.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">data_div</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">extract_restaurant_metadata</span><span class="p">(</span><span class="n">data_div</span><span class="p">)</span>
    <span class="n">inspection_data</span> <span class="o">=</span> <span class="n">get_score_data</span><span class="p">(</span><span class="n">data_div</span><span class="p">)</span>
    <span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">inspection_data</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">metadata</span>
</pre></div>
</div>
<p>And test it out at the command line:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">(</span>soupenv<span class="o">)</span>$ python mashup.py
...
<span class="o">{</span>u<span class="s1">&#39;Business Category&#39;</span>: <span class="o">[</span>u<span class="s1">&#39;Seating 0-12 - Risk Category III&#39;</span><span class="o">]</span>,
 u<span class="s1">&#39;Longitude&#39;</span>: <span class="o">[</span>u<span class="s1">&#39;122.3401786000&#39;</span><span class="o">]</span>, u<span class="s1">&#39;High Score&#39;</span>: 0,
 u<span class="s1">&#39;Phone&#39;</span>: <span class="o">[</span>u<span class="s1">&#39;(206) 501-9554&#39;</span><span class="o">]</span>, u<span class="s1">&#39;Business Name&#39;</span>: <span class="o">[</span>u<span class="s2">&quot;ZACCAGNI&#39;S&quot;</span><span class="o">]</span>,
 u<span class="s1">&#39;Total Inspections&#39;</span>: 0, u<span class="s1">&#39;Address&#39;</span>: <span class="o">[</span>u<span class="s1">&#39;97B PIKE ST&#39;</span>, u<span class="s1">&#39;SEATTLE, WA 98101&#39;</span><span class="o">]</span>,
 u<span class="s1">&#39;Latitude&#39;</span>: <span class="o">[</span>u<span class="s1">&#39;47.6086651300&#39;</span><span class="o">]</span>, u<span class="s1">&#39;Average Score&#39;</span>: 0<span class="o">}</span>
</pre></div>
</div>
</div>



<div class="slide-no">54</div>


    </article>
  </slide>  <slide class="level-3" id="break-time">
    <hgroup>
      <h3>Break Time</h3>
    </hgroup>
    <article class="">
      <p>Once you have this working, take a break.</p>
<p>When we return, we'll try a saner approach to getting data from online</p>



<div class="slide-no">55</div>


    </article>
  </slide>  <slide class="level-2" id="another-approach">
    <hgroup>
      <h2>Another Approach</h2>
    </hgroup>
    <article class="">
      <div class="left docutils container">
<p>Scraping web pages is tedious and inherently brittle</p>
<div class="build docutils container">
<p>The owner of the website updates their layout, your code breaks</p>
<p>But there is another way to get information from the web in a more normalized
fashion</p>
<p class="centered"><strong>Web Services</strong></p>
</div>
</div>



<div class="slide-no">56</div>


    </article>
  </slide>  <slide class="level-3" id="web-services">
    <hgroup>
      <h3>Web Services</h3>
    </hgroup>
    <article class="">
      <p>&quot;a software system designed to support interoperable machine-to-machine
interaction over a network&quot; - W3C</p>
<ul class="build simple">
<li>provides a defined set of calls</li>
<li>returns structured data</li>
</ul>



<div class="slide-no">57</div>


    </article>
  </slide>  <slide class="level-3" id="id39">
    <hgroup>
      <h3>Early Web Services</h3>
    </hgroup>
    <article class="">
      <p><strong>RSS</strong> is one of the earliest forms of Web Services</p>
<div class="build docutils container">
<p>A single web-based <em>endpoint</em> provides a dynamically updated listing of
content</p>
<p>Implemented in pure HTTP.  Returns XML</p>
<p><strong>Atom</strong> is a competing, but similar standard</p>
<p>There's a solid Python library for consuming RSS: <a class="reference external" href="https://pythonhosted.org/feedparser/">feedparser</a>.</p>
</div>



<div class="slide-no">58</div>


    </article>
  </slide>  <slide class="level-3" id="id40">
    <hgroup>
      <h3>XML-RPC</h3>
    </hgroup>
    <article class="">
      <p>XML-RPC extended the essentially static nature of RSS by allowing users to call
procedures and pass arguments.</p>
<div class="build docutils container">
<ul class="build simple">
<li>Calls are made via HTTP GET, by passing an XML document</li>
<li>Returns from a call are sent to the client in XML</li>
</ul>
<p>In python, you can access XML-RPC services using <a class="reference external" href="https://docs.python.org/3.5/library/xmlrpc.html">xmlrpc</a> from the
standard library. It has two libraries, <code class="docutils literal"><span class="pre">xmlrpc.client</span></code> and
<code class="docutils literal"><span class="pre">xmlrpc.server</span></code></p>
</div>



<div class="slide-no">59</div>


    </article>
  </slide>  <slide class="level-3" id="id41">
    <hgroup>
      <h3>SOAP</h3>
    </hgroup>
    <article class="">
      <p>SOAP extends XML-RPC in a couple of useful ways:</p>
<ul class="build simple">
<li>It uses Web Services Description Language (WSDL) to provide meta-data about
an entire service in a machine-readable format (Automatic introspection)</li>
<li>It establishes a method for extending available data types using XML
namespaces</li>
</ul>
<div class="build docutils container">
<p>There is no standard library module that supports SOAP directly.</p>
<ul class="build simple">
<li>The best-known and best-supported module available is <strong>Suds</strong></li>
<li>The homepage is <a class="reference external" href="https://fedorahosted.org/suds/">https://fedorahosted.org/suds/</a></li>
<li>It can be installed using <code class="docutils literal"><span class="pre">easy_install</span></code> or <code class="docutils literal"><span class="pre">pip</span> <span class="pre">install</span></code></li>
<li>A <a class="reference external" href="https://github.com/cackharot/suds-py3">fork of the library</a> compatible with Python 3 does exist</li>
</ul>
<p><strong>I HATE SOAP</strong></p>
</div>



<div class="slide-no">60</div>


    </article>
  </slide>  <slide class="level-3" id="id42">
    <hgroup>
      <h3>What about WSDL?</h3>
    </hgroup>
    <article class="">
      <p>SOAP was invented in part to provide completely machine-readable
interoperability.</p>
<div class="build docutils container">
<p><em>Does that really work in real life?</em></p>
<p class="centered"><strong>Hardly ever</strong></p>
<p>Another reason was to provide extensibility via custom types</p>
<p><em>Does that really work in real life?</em></p>
<p class="centered"><strong>Hardly ever</strong></p>
</div>



<div class="slide-no">61</div>


    </article>
  </slide>  <slide class="level-3" id="id43">
    <hgroup>
      <h3>I have to write XML?</h3>
    </hgroup>
    <article class="">
      <p>In addition, XML is a pretty inefficient medium for transmitting data.  There's
a lot of extra characters transmitted that lack any meaning.</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="nt">&lt;soap:Envelope</span> <span class="na">xmlns:soap=</span><span class="s">&quot;http://www.w3.org/2003/05/soap-envelope&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;soap:Header&gt;</span>
  <span class="nt">&lt;/soap:Header&gt;</span>
  <span class="nt">&lt;soap:Body&gt;</span>
    <span class="nt">&lt;m:GetStockPrice</span> <span class="na">xmlns:m=</span><span class="s">&quot;http://www.example.org/stock/Surya&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;m:StockName&gt;</span>IBM<span class="nt">&lt;/m:StockName&gt;</span>
    <span class="nt">&lt;/m:GetStockPrice&gt;</span>
  <span class="nt">&lt;/soap:Body&gt;</span>
<span class="nt">&lt;/soap:Envelope&gt;</span>
</pre></div>
</div>



<div class="slide-no">62</div>


    </article>
  </slide>  <slide class="level-3" id="id44">
    <hgroup>
      <h3>Why Do All The Work?</h3>
    </hgroup>
    <article class="">
      <p>So, if neither of the original goals is really achieved by using SOAP</p>
<div class="build docutils container">
<p>And if the transmission medium is too bloated to use</p>
<p>why pay all the overhead required to use the protocol?</p>
<p>Is there another way we could consider approaching the problem?</p>
<p class="centered"><strong>Enter REST</strong></p>
</div>



<div class="slide-no">63</div>


    </article>
  </slide>  <slide class="level-3" id="rest">
    <hgroup>
      <h3>REST</h3>
    </hgroup>
    <article class="">
      <p class="centered"><strong>Representational State Transfer</strong></p>
<div class="build docutils container">
<ul class="build simple">
<li>Originally described by Roy T. Fielding (worth reading)</li>
<li>Use HTTP for what it can do</li>
<li>Read more in <a class="reference external" href="http://www.crummy.com/writing/RESTful-Web-Services/">RESTful Web Services</a>*</li>
</ul>
<p>* Seriously. Buy it and read it</p>
</div>



<div class="slide-no">64</div>


    </article>
  </slide>  <slide class="level-3" id="id45">
    <hgroup>
      <h3>A Comparison</h3>
    </hgroup>
    <article class="">
      <p>The XML-RCP/SOAP way:</p>
<ul class="build simple">
<li>POST /getComment HTTP/1.1</li>
<li>POST /getComments HTTP/1.1</li>
<li>POST /addComment HTTP/1.1</li>
<li>POST /editComment HTTP/1.1</li>
<li>POST /deleteComment HTTP/1.1</li>
</ul>
<div class="build docutils container">
<p>The RESTful way:</p>
<ul class="build simple">
<li>GET /comment/&lt;id&gt; HTTP/1.1</li>
<li>GET /comment HTTP/1.1</li>
<li>POST /comment HTTP/1.1</li>
<li>PUT /comment/&lt;id&gt; HTTP/1.1</li>
<li>DELETE /comment/&lt;id&gt; HTTP/1.1</li>
</ul>
</div>



<div class="slide-no">65</div>


    </article>
  </slide>  <slide class="level-3" id="id46">
    <hgroup>
      <h3>ROA</h3>
    </hgroup>
    <article class="">
      <p>REST is a <strong>Resource Oriented Architecture</strong></p>
<div class="build docutils container">
<p>The URL represents the <em>resource</em> we are working with</p>
<p>The HTTP Method indicates the <code class="docutils literal"><span class="pre">action</span></code> to be taken</p>
<p>The HTTP Code returned tells us the <code class="docutils literal"><span class="pre">result</span></code> (whether success or failure)</p>
</div>



<div class="slide-no">66</div>


    </article>
  </slide>  <slide class="level-3" id="id47">
    <hgroup>
      <h3>HTTP Codes Revisited</h3>
    </hgroup>
    <article class="">
      <div class="build docutils container">
<p>POST /comment HTTP/1.1  (creating a new comment):</p>
<ul class="build simple">
<li>Success: <code class="docutils literal"><span class="pre">HTTP/1.1</span> <span class="pre">201</span> <span class="pre">Created</span></code></li>
<li>Failure (unauthorized): <code class="docutils literal"><span class="pre">HTTP/1.1</span> <span class="pre">401</span> <span class="pre">Unauthorized</span></code></li>
<li>Failure (NotImplemented): <code class="docutils literal"><span class="pre">HTTP/1.1</span> <span class="pre">405</span> <span class="pre">Not</span> <span class="pre">Allowed</span></code></li>
<li>Failure (ValueError): <code class="docutils literal"><span class="pre">HTTP/1.1</span> <span class="pre">406</span> <span class="pre">Not</span> <span class="pre">Acceptable</span></code></li>
</ul>
<p>PUT /comment/&lt;id&gt; HTTP/1.1 (edit comment):</p>
<ul class="build simple">
<li>Success: <code class="docutils literal"><span class="pre">HTTP/1.1</span> <span class="pre">200</span> <span class="pre">OK</span></code></li>
<li>Failure: <code class="docutils literal"><span class="pre">HTTP/1.1</span> <span class="pre">409</span> <span class="pre">Conflict</span></code></li>
</ul>
<p>DELETE /comment/&lt;id&gt; HTTP/1.1 (delete comment):</p>
<ul class="build simple">
<li>Success: <code class="docutils literal"><span class="pre">HTTP/1.1</span> <span class="pre">204</span> <span class="pre">No</span> <span class="pre">Content</span></code></li>
</ul>
</div>



<div class="slide-no">67</div>


    </article>
  </slide>  <slide class="level-3" id="rest-uses-json">
    <hgroup>
      <h3>REST uses JSON</h3>
    </hgroup>
    <article class="">
      <p>JavaScript Object Notation:</p>
<div class="build docutils container">
<ul class="build simple">
<li>a lightweight data-interchange format</li>
<li>easy for humans to read and write</li>
<li>easy for machines to parse and generate</li>
</ul>
<p>Based on Two Structures:</p>
<ul class="simple">
<li>object: <code class="docutils literal"><span class="pre">{</span> <span class="pre">string:</span> <span class="pre">value,</span> <span class="pre">...}</span></code></li>
<li>array: <code class="docutils literal"><span class="pre">[value,</span> <span class="pre">value,</span> <span class="pre">]</span></code></li>
</ul>
<p class="centered">pythonic, no?</p>
</div>



<div class="slide-no">68</div>


    </article>
  </slide>  <slide class="level-3" id="id48">
    <hgroup>
      <h3>JSON Data Types</h3>
    </hgroup>
    <article class="">
      <p>JSON provides a few basic data types (see <a class="reference external" href="http://json.org/">http://json.org/</a>):</p>
<div class="build docutils container">
<ul class="build simple">
<li>string: unicode, anything but &quot;, \ and control characters</li>
<li>number: any number, but json does not use octal or hexadecimal</li>
<li>object, array (we've seen these above)</li>
<li>true</li>
<li>false</li>
<li>null</li>
</ul>
<p class="centered"><strong>No date type? OMGWTF??!!1!1</strong></p>
</div>



<div class="slide-no">69</div>


    </article>
  </slide>  <slide class="level-3" id="id49">
    <hgroup>
      <h3>Dates in JSON</h3>
    </hgroup>
    <article class="">
      <p>You have two options:</p>
<div class="build docutils container">
<div class="docutils container">
<p>Option 1 - Unix Epoch Time (number):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">time</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="go">1358212616.7691269</span>
</pre></div>
</div>
</div>
<div class="docutils container">
<p>Option 2 - ISO 8661 (string):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<span class="go">&#39;2013-01-14T17:18:10.727240&#39;</span>
</pre></div>
</div>
</div>
</div>



<div class="slide-no">70</div>


    </article>
  </slide>  <slide class="level-3" id="json-in-python">
    <hgroup>
      <h3>JSON in Python</h3>
    </hgroup>
    <article class="">
      <p>You can encode python to json, and decode json back to python:</p>
<div class="build docutils container">
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">json</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">array</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="s1">&#39;[1, 2, 3]&#39;</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">orig</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;my resum√©&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">encoded</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="n">encoded</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="s1">&#39;{&quot;foo&quot;: [1, 2, 3], &quot;bar&quot;: &quot;my resum</span><span class="se">\\</span><span class="s1">u00e9&quot;, &quot;baz&quot;: true}&#39;</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="n">decoded</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="n">decoded</span> <span class="o">==</span> <span class="n">orig</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="bp">True</span>
</pre></div>
</div>
<p>Customizing the encoder or decoder class allows for specialized serializations</p>
</div>



<div class="slide-no">71</div>


    </article>
  </slide>  <slide class="level-3" id="id50">
    <hgroup>
      <h3>JSON in Python</h3>
    </hgroup>
    <article class="">
      <p>the json module also supports reading and writing to <em>file-like objects</em> via
<code class="docutils literal"><span class="pre">json.dump(fp)</span></code> and <code class="docutils literal"><span class="pre">json.load(fp)</span></code> (note the missing 's')</p>
<div class="build docutils container">
<p>Remember duck-typing. Anything with a <code class="docutils literal"><span class="pre">.write</span></code> and a <code class="docutils literal"><span class="pre">.read</span></code> method is
<em>file-like</em></p>
<p>This usage can be much more memory-friendly with large files/sources</p>
</div>



<div class="slide-no">72</div>


    </article>
  </slide>  <slide class="level-3" id="playing-with-rest">
    <hgroup>
      <h3>Playing With REST</h3>
    </hgroup>
    <article class="">
      <p>Let's take a moment to play with REST.</p>
<div class="build docutils container">
<p>We'll use a common, public API provided by Google.</p>
<p class="centered"><strong>Geocoding</strong></p>
</div>



<div class="slide-no">73</div>


    </article>
  </slide>  <slide class="level-3" id="id51">
    <hgroup>
      <h3>Geocoding with Google APIs</h3>
    </hgroup>
    <article class="">
      <p><a class="reference external" href="https://developers.google.com/maps/documentation/geocoding">https://developers.google.com/maps/documentation/geocoding</a></p>
<div class="build docutils container">
<p>Open a python interpreter using our virtualenv:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>(soupenv)$ python
</pre></div>
</div>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [1]: </span><span class="kn">import</span> <span class="nn">requests</span>
<span class="gp">In [2]: </span><span class="kn">import</span> <span class="nn">json</span>
<span class="gp">In [3]: </span><span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="gp">In [4]: </span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://maps.googleapis.com/maps/api/geocode/json&#39;</span>
<span class="gp">In [5]: </span><span class="n">addr</span> <span class="o">=</span> <span class="s1">&#39;1325 4th Ave, Seattle, 98101&#39;</span>
<span class="gp">In [6]: </span><span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;address&#39;</span><span class="p">:</span> <span class="n">addr</span><span class="p">,</span> <span class="s1">&#39;sensor&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span><span class="p">}</span>
<span class="gp">In [7]: </span><span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">parameters</span><span class="p">)</span>
<span class="gp">In [8]: </span><span class="n">data</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</pre></div>
</div>
</div>



<div class="slide-no">74</div>


    </article>
  </slide>  <slide class="level-3" id="id52">
    <hgroup>
      <h3>Reverse Geocoding</h3>
    </hgroup>
    <article class="">
      <p>You can do the same thing in reverse, supply latitude and longitude and get
back address information:</p>
<div class="build docutils container">
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [15]: </span><span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;OK&#39;</span><span class="p">:</span>
<span class="gp">   ....: </span>    <span class="n">pprint</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">])</span>
<span class="gp">   ....:</span>
<span class="go">[{&#39;address_components&#39;: [{&#39;long_name&#39;: &#39;1325&#39;,</span>
<span class="go">                          &#39;short_name&#39;: &#39;1325&#39;,</span>
<span class="go">  ...</span>
<span class="go">  &#39;types&#39;: [&#39;street_address&#39;]}]</span>
</pre></div>
</div>
<p>Notice that there may be a number of results returned, ordered from most
specific to least.</p>
</div>



<div class="slide-no">75</div>


    </article>
  </slide>  <slide class="level-3" id="mashing-it-up">
    <hgroup>
      <h3>Mashing It Up</h3>
    </hgroup>
    <article class="">
      <p>Google's geocoding data is quite nice.</p>
<div class="build docutils container">
<p>But it's not in a format we can use directly to create a map</p>
<p>For that we need <cite>geojson</cite></p>
<p>Moreover, formatting the data for all those requests is going to get
tedious.</p>
<p>Luckily, people create <em>wrappers</em> for popular REST apis like google's
geocoding service.</p>
<p>Once such wrapper is <a class="reference external" href="http://geocoder.readthedocs.org/en/latest/">geocoder</a>, which provides not only google's service,
but many others under a single umbrella.</p>
</div>



<div class="slide-no">76</div>


    </article>
  </slide>  <slide class="level-3" id="id53">
    <hgroup>
      <h3>Install <code class="docutils literal"><span class="pre">geocoder</span></code></h3>
    </hgroup>
    <article class="">
      <p>Install geocoder into your <code class="docutils literal"><span class="pre">soupenv</span></code> so that it's available to use:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">(</span>soupenv<span class="o">)</span>$ pip install geocoder
</pre></div>
</div>
<div class="build docutils container">
<p>Our final step for tonight will be to geocode the results we have scraped
from the inspection site.</p>
<p>We'll then convert that to <code class="docutils literal"><span class="pre">geojson</span></code>, insert our own properties and map
the results.</p>
<p>Let's begin by converting our script so that what we have so far is
contained in a generator function</p>
<p>We'll eventually sort our results and generate the top 10 or so for
geocoding.</p>
<p>Open up <code class="docutils literal"><span class="pre">mashup.py</span></code> and copy everthing in the <code class="docutils literal"><span class="pre">main</span></code> block.</p>
</div>



<div class="slide-no">77</div>


    </article>
  </slide>  <slide class="level-3" id="id54">
    <hgroup>
      <h3>Make a Generator Function</h3>
    </hgroup>
    <article class="">
      <p>Add a new function <code class="docutils literal"><span class="pre">result_generator</span></code> to the <code class="docutils literal"><span class="pre">mashup.py</span></code> script. Paste the
code you copied from the <code class="docutils literal"><span class="pre">main</span></code> block and then update it a bit:</p>
<div class="build highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">result_generator</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="n">use_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Inspection_Start&#39;</span><span class="p">:</span> <span class="s1">&#39;2/1/2013&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Inspection_End&#39;</span><span class="p">:</span> <span class="s1">&#39;2/1/2015&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Zip_Code&#39;</span><span class="p">:</span> <span class="s1">&#39;98101&#39;</span>
    <span class="p">}</span>
    <span class="c1"># html, encoding = get_inspection_page(**use_params)</span>
    <span class="n">html</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="n">load_inspection_page</span><span class="p">(</span><span class="s1">&#39;inspection_page.html&#39;</span><span class="p">)</span>
    <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse_source</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span>
    <span class="n">content_col</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;td&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;contentcol&quot;</span><span class="p">)</span>
    <span class="n">data_list</span> <span class="o">=</span> <span class="n">restaurant_data_generator</span><span class="p">(</span><span class="n">content_col</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">data_div</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">[:</span><span class="n">count</span><span class="p">]:</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">extract_restaurant_metadata</span><span class="p">(</span><span class="n">data_div</span><span class="p">)</span>
        <span class="n">inspection_data</span> <span class="o">=</span> <span class="n">get_score_data</span><span class="p">(</span><span class="n">data_div</span><span class="p">)</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">inspection_data</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">metadata</span>
</pre></div>
</div>



<div class="slide-no">78</div>


    </article>
  </slide>  <slide class="level-3" id="id55">
    <hgroup>
      <h3>Test It Out</h3>
    </hgroup>
    <article class="">
      <p>Update the <code class="docutils literal"><span class="pre">main</span></code> block of your <code class="docutils literal"><span class="pre">mashup.py</span></code> script to use the new function:</p>
<div class="build docutils container">
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">result_generator</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">print</span> <span class="n">result</span>
</pre></div>
</div>
<p>Then run your script and verify that the only thing that has changed is the
number of results that print.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">(</span>soupenv<span class="o">)</span>$ python mashup.py
<span class="c1"># you should see 10 dictionaries print here.</span>
</pre></div>
</div>
</div>



<div class="slide-no">79</div>


    </article>
  </slide>  <slide class="level-3" id="add-geocoding">
    <hgroup>
      <h3>Add Geocoding</h3>
    </hgroup>
    <article class="">
      <p>The API for geocoding with <code class="docutils literal"><span class="pre">geocoder</span></code> is the same for all providers.</p>
<div class="build docutils container">
<p>You give an address, it returns geocoded data.</p>
<p>You provide latitude and longitude, it provides address data</p>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [1]: </span><span class="n">response</span> <span class="o">=</span> <span class="n">geocoder</span><span class="o">.</span><span class="n">google</span><span class="p">(</span><span class="o">&lt;</span><span class="n">address</span><span class="o">&gt;</span><span class="p">)</span>
<span class="gp">In [2]: </span><span class="n">response</span><span class="o">.</span><span class="n">json</span>
<span class="gh">Out[2]: </span><span class="go"># json result data</span>
<span class="gp">In [3]: </span><span class="n">response</span><span class="o">.</span><span class="n">geojson</span>
<span class="gh">Out[3]: </span><span class="go"># geojson result data</span>
</pre></div>
</div>
</div>



<div class="slide-no">80</div>


    </article>
  </slide>  <slide class="level-3" id="id56">
    <hgroup>
      <h3>Adding The Function</h3>
    </hgroup>
    <article class="">
      <p>Let's add a new function <code class="docutils literal"><span class="pre">get_geojson</span></code> to <code class="docutils literal"><span class="pre">mashup.py</span></code></p>
<div class="build docutils container">
<p>It will</p>
<ul class="build simple">
<li>Take a result from our search as it's input</li>
<li>Get geocoding data from google using the address of the restaurant</li>
<li>Return the geojson representation of that data</li>
</ul>
<p>Try to write this function on your own</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_geojson</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="n">address</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Address&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">address</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="n">geocoded</span> <span class="o">=</span> <span class="n">geocoder</span><span class="o">.</span><span class="n">google</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">geocoded</span><span class="o">.</span><span class="n">geojson</span>
</pre></div>
</div>
</div>



<div class="slide-no">81</div>


    </article>
  </slide>  <slide class="level-3" id="id57">
    <hgroup>
      <h3>Testing It Out</h3>
    </hgroup>
    <article class="">
      <p>Next, update our <code class="docutils literal"><span class="pre">main</span></code> block to get the geojson for each result and print
it:</p>
<div class="build docutils container">
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">result_generator</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">geojson</span> <span class="o">=</span> <span class="n">get_geojson</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">geojson</span>
</pre></div>
</div>
<p>Then test your results by running your script:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">(</span>soupenv<span class="o">)</span>$ python mashup.py
<span class="o">{</span><span class="s1">&#39;geometry&#39;</span>: <span class="o">{</span><span class="s1">&#39;type&#39;</span>: <span class="s1">&#39;Point&#39;</span>, <span class="s1">&#39;coordinates&#39;</span>: <span class="o">[</span>-122.3393005, 47.6134378<span class="o">]}</span>,
 <span class="s1">&#39;type&#39;</span>: <span class="s1">&#39;Feature&#39;</span>, <span class="s1">&#39;properties&#39;</span>: <span class="o">{</span><span class="s1">&#39;neighborhood&#39;</span>: <span class="s1">&#39;Belltown&#39;</span>,
 <span class="s1">&#39;encoding&#39;</span>: <span class="s1">&#39;utf-8&#39;</span>, <span class="s1">&#39;county&#39;</span>: <span class="s1">&#39;King County&#39;</span>, <span class="s1">&#39;city_long&#39;</span>: <span class="s1">&#39;Seattle&#39;</span>,
 <span class="s1">&#39;lng&#39;</span>: -122.3393005, <span class="s1">&#39;quality&#39;</span>: u<span class="s1">&#39;street_address&#39;</span>, <span class="s1">&#39;city&#39;</span>: <span class="s1">&#39;Seattle&#39;</span>,
 <span class="s1">&#39;confidence&#39;</span>: 9, <span class="s1">&#39;state&#39;</span>: <span class="s1">&#39;WA&#39;</span>, <span class="s1">&#39;location&#39;</span>: u<span class="s1">&#39;1933 5TH AVE SEATTLE, WA 98101&#39;</span>,
 <span class="s1">&#39;provider&#39;</span>: <span class="s1">&#39;google&#39;</span>, <span class="s1">&#39;housenumber&#39;</span>: <span class="s1">&#39;1933&#39;</span>, <span class="s1">&#39;accuracy&#39;</span>: <span class="s1">&#39;ROOFTOP&#39;</span>,
 <span class="s1">&#39;status&#39;</span>: <span class="s1">&#39;OK&#39;</span>, <span class="s1">&#39;state_long&#39;</span>: <span class="s1">&#39;Washington&#39;</span>,
 <span class="s1">&#39;address&#39;</span>: <span class="s1">&#39;1933 5th Avenue, Seattle, WA 98101, USA&#39;</span>, <span class="s1">&#39;lat&#39;</span>: 47.6134378,
 <span class="s1">&#39;postal&#39;</span>: <span class="s1">&#39;98101&#39;</span>, <span class="s1">&#39;ok&#39;</span>: True, <span class="s1">&#39;road_long&#39;</span>: <span class="s1">&#39;5th Avenue&#39;</span>, <span class="s1">&#39;country&#39;</span>: <span class="s1">&#39;US&#39;</span>,
 <span class="s1">&#39;country_long&#39;</span>: <span class="s1">&#39;United States&#39;</span>, <span class="s1">&#39;street&#39;</span>: <span class="s1">&#39;5th Ave&#39;</span><span class="o">}</span>,
 <span class="s1">&#39;bbox&#39;</span>: <span class="o">[</span>-122.3406494802915, 47.6120888197085, -122.3379515197085, 47.6147867802915<span class="o">]}</span>
</pre></div>
</div>
</div>



<div class="slide-no">82</div>


    </article>
  </slide>  <slide class="level-3" id="id58">
    <hgroup>
      <h3>Update Geojson Properties</h3>
    </hgroup>
    <article class="">
      <p>The <code class="docutils literal"><span class="pre">properties</span></code> of our geojson records are filled with data we don't really
care about.</p>
<div class="build docutils container">
<p>Let's replace that information with some of the metadata from our
inspection results.</p>
<p>We'll update our <code class="docutils literal"><span class="pre">get_geojson</span></code> function so that it:</p>
<ul class="build simple">
<li>Builds a dictionary containing only the values we want from our
inspection record.</li>
<li>Converts list values to strings (geojson requires this)</li>
<li>Replaces the 'properties' of our geojson with this new data</li>
<li>Returns the modified geojson record</li>
</ul>
</div>



<div class="slide-no">83</div>


    </article>
  </slide>  <slide class="level-3" id="id59">
    <hgroup>
      <h3>Write the Function</h3>
    </hgroup>
    <article class="">
      <p>See if you can make the updates on your own.</p>
<div class="build highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_geojson</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="n">geocoded</span> <span class="o">=</span> <span class="n">geocoder</span><span class="o">.</span><span class="n">google</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
    <span class="n">geojson</span> <span class="o">=</span> <span class="n">geocoded</span><span class="o">.</span><span class="n">geojson</span>
    <span class="n">inspection_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">use_keys</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;Business Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Average Score&#39;</span><span class="p">,</span> <span class="s1">&#39;Total Inspections&#39;</span><span class="p">,</span> <span class="s1">&#39;High Score&#39;</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">use_keys</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="n">inspection_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
    <span class="n">geojson</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inspection_data</span>
    <span class="k">return</span> <span class="n">geojson</span>
</pre></div>
</div>



<div class="slide-no">84</div>


    </article>
  </slide>  <slide class="level-3" id="id60">
    <hgroup>
      <h3>Making Mappable Data</h3>
    </hgroup>
    <article class="">
      <p>We are now generating a series of <code class="docutils literal"><span class="pre">geojson</span></code> <em>Feature</em> objects.</p>
<div class="build docutils container">
<p>To map these objects, we'll need to create a file which contains a
<code class="docutils literal"><span class="pre">geojson</span></code> <em>FeatureCollection</em>.</p>
<p>The structure of such a collection looks like this:</p>
<div class="highlight-json"><div class="highlight"><pre><span></span>{&#39;type&#39;: &#39;FeatureCollection&#39;, &#39;features&#39;: [...]}
</pre></div>
</div>
<p>Let's update our <code class="docutils literal"><span class="pre">main</span></code> function to append each feature to such a
structure.</p>
<p>Then we can dump the structure as <code class="docutils literal"><span class="pre">json</span></code> to a file.</p>
</div>



<div class="slide-no">85</div>


    </article>
  </slide>  <slide class="level-3" id="id61">
    <hgroup>
      <h3>Update the Script</h3>
    </hgroup>
    <article class="">
      <p>In <code class="docutils literal"><span class="pre">mashup.py</span></code> update the <code class="docutils literal"><span class="pre">main</span></code> block like so:</p>
<div class="build docutils container">
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># add an import at the top:</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">total_result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;FeatureCollection&#39;</span><span class="p">,</span> <span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">result_generator</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">geojson</span> <span class="o">=</span> <span class="n">get_geojson</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">total_result</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geojson</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;my_map.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">total_result</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span>
</pre></div>
</div>
<p>When you run the script nothing will print, but the new file will appear.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">(</span>soupenv<span class="o">)</span>$ python mashup.py
</pre></div>
</div>
<p>This script is available as <code class="docutils literal"><span class="pre">resources/session04/mashup_5.py</span></code></p>
</div>



<div class="slide-no">86</div>


    </article>
  </slide>  <slide class="level-3" id="display-the-results">
    <hgroup>
      <h3>Display the Results</h3>
    </hgroup>
    <article class="">
      <p>Once the new file is written you are ready to display your results.</p>
<div class="build docutils container">
<p>Open your web browser and go to <a class="reference external" href="http://geojson.io">http://geojson.io</a></p>
<p>Then drag and drop the new file you wrote onto the map you see there.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/geojson-io.png"><img alt="../_images/geojson-io.png" src="../_images/geojson-io.png" style="width: 75%;" /></a>
</div>
</div>



<div class="slide-no">87</div>


    </article>
  </slide>  <slide class="level-3" id="wrap-up">
    <hgroup>
      <h3>Wrap Up</h3>
    </hgroup>
    <article class="">
      <p>We've built a simple mashup combining data from different sources.</p>
<div class="build docutils container">
<p>We scraped health inspection data from the King County government site.</p>
<p>We geocoded that data.</p>
<p>And we've displayed the results on a map.</p>
<p>What other sources of data might we choose to combine?</p>
<p>Check out <a class="reference external" href="http://www.programmableweb.com/apis/directory">programmable web</a>
to see some of the possibilities</p>
</div>



<div class="slide-no">88</div>


    </article>
  </slide>  <slide class="level-2" id="homework">
    <hgroup>
      <h2>Homework</h2>
    </hgroup>
    <article class="">
      <div class="left docutils container">
<p>For your homework this week, you'll be polishing this mashup.</p>
<div class="build docutils container">
<p>Begin by sorting the results of our search by the average score (can
you do this and still use a generator for getting the geojson?).</p>
<p>Then, update your script to allow the user to choose how to sort, by
average, high score or most inspections:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>(soupenv)$ python mashup.py highscore
</pre></div>
</div>
<p>Next, allow the user to choose how many results to map:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>(soupenv)$ python mashup.py highscore 25
</pre></div>
</div>
<p>Or allow them to reverse the results, showing the lowest scores first:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>(soupenv)$ python mashup.py highscore 25 reverse
</pre></div>
</div>
<p>If you're feeling particularly adventurous, see if you can use the
<a class="reference external" href="https://docs.python.org/2/library/argparse.html#module-argparse">argparse</a> module from the standard library to handle command line
arguments</p>
</div>
</div>



<div class="slide-no">89</div>


    </article>
  </slide>  <slide class="level-3" id="more-fun">
    <hgroup>
      <h3>More Fun</h3>
    </hgroup>
    <article class="">
      <p>Next, try adding a bit of information to your map by setting the
<code class="docutils literal"><span class="pre">marker-color</span></code> property. This will display a marker with the provided
css-style color (<code class="docutils literal"><span class="pre">#FF0000</span></code>)</p>
<div class="build docutils container">
<p>See if you can make the color change according to the values used for the
sorting of the list.  Either vary the intensity of the color, or the hue.</p>
<p>Finally, if you are feeling particularly frisky, you can update your script
to automatically open a browser window with your map loaded on
<em>geojson.io</em>.</p>
<p>To do this, you'll want to read about the <a class="reference external" href="https://docs.python.org/3/library/webbrowser.html">webbrowser</a> module from the
standard library.</p>
<p>In addition, you'll want to read up on using the URL parameters API for
<em>geojson.io</em>.  Click on the <strong>help</strong> tab in the sidebar to view the
information.</p>
<p>You will also need to learn about how to properly quote special characters
for a URL, using the <a class="reference external" href="https://docs.python.org/3/library/urllib.parse.html#urllib.parse.quote">urllib.parse</a> <code class="docutils literal"><span class="pre">quote</span></code> function.</p>
</div>



<div class="slide-no">90</div>


    </article>
  </slide>  <slide class="level-3" id="submitting-your-work">
    <hgroup>
      <h3>Submitting Your Work</h3>
    </hgroup>
    <article class="">
      <p>Create a github repository to contain your mashup work. Start by populating it
with the script as we finished it today (mashup_5.py).</p>
<p>As you implement the above features, commit early and commit often.</p>
<p>When you're ready for us to look it over, email a link to your repository to
Maria and I.</p>



<div class="slide-no">91</div>


    </article>
  </slide>


    <slide class="thank-you-slide segue nobackground">
    <aside class="gdbar right"><img src="../_static/logo_UW.png"></aside>
    <article class="flexbox vleft auto-fadein">
      <h2>Good Night!</h2>
      <p>&nbsp;</p>
    </article>
    <p class="auto-fadein" data-config-contact>
      <!-- populated from slide_config.json -->
    </p>
  </slide>

  <slide class="backdrop"></slide>

</slides>

<!--[if IE]>
  <script src="http://ajax.googleapis.com/ajax/libs/chrome-frame/1/CFInstall.min.js"></script>
  <script>CFInstall.check({mode: 'overlay'});</script>
<![endif]-->
</body>
</html>